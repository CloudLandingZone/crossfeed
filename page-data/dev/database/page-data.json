{"componentChunkName":"component---src-templates-documentation-page-js","path":"/dev/database/","result":{"data":{"markdownRemark":{"html":"<p>Crossfeed uses a relational database that uses Postgres. When running Crossfeed locally, the database is served from the container <code class=\"language-text\">crossfeed_db_1</code>. We rarely issue direct SQL queries to the database, but instead\nuse <a href=\"https://typeorm.io/#/\">TypeORM</a> to communicate with it.</p>\n<h3 id=\"directory-structure\" style=\"position:relative;\"><a href=\"#directory-structure\" aria-label=\"directory structure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Directory structure</h3>\n<p>The <code class=\"language-text\">backend/src/models</code> folder contains all the TypeORM models.</p>\n<p>The database is deployed onto AWS RDS. Configuration for this deployment is located in <code class=\"language-text\">infrastructure/database.tf</code>.</p>\n<h3 id=\"models\" style=\"position:relative;\"><a href=\"#models\" aria-label=\"models permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Models</h3>\n<p>Here is a list of database models used by Crossfeed:</p>\n<table>\n<thead>\n<tr>\n<th>Model Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Domain</td>\n<td>A Domain stores a record for each domain / subdomain found by Crossfeed.</td>\n</tr>\n<tr>\n<td>Service</td>\n<td>A Service runs on a given port on a domain, for example, \"http\" or \"ftp\".</td>\n</tr>\n<tr>\n<td>Vulnerability</td>\n<td>A Vulnerability is an indicator of a vulnerability, unique to a domain, such as a CVE.</td>\n</tr>\n<tr>\n<td>Webpage</td>\n<td>A Webpage is a web path that has been scraped on a Domain.</td>\n</tr>\n<tr>\n<td>ApiKey</td>\n<td>An ApiKey can be generated by users to programmatically access the Crossfeed API.</td>\n</tr>\n<tr>\n<td>Organization</td>\n<td>An Organization represents an entity to be scanned that has a defined scope of root domains.</td>\n</tr>\n<tr>\n<td>OrganizationTag</td>\n<td>An OrganizationTag can be used to group multiple organizations.</td>\n</tr>\n<tr>\n<td>Role</td>\n<td>A Role represents a User's access level to an Organization.</td>\n</tr>\n<tr>\n<td>User</td>\n<td>A User is an account that can access Crossfeed.</td>\n</tr>\n<tr>\n<td>SavedSearch</td>\n<td>A SavedSearch is a search that a User has saved.</td>\n</tr>\n<tr>\n<td>Scan</td>\n<td>A Scan is a scheduled data collection job.</td>\n</tr>\n<tr>\n<td>ScanTask</td>\n<td>A ScanTask represents a specific run, at a certain time and date, of a Scan.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"syncing-the-database\" style=\"position:relative;\"><a href=\"#syncing-the-database\" aria-label=\"syncing the database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Syncing the database</h3>\n<p>You should sync the database using the <code class=\"language-text\">syncdb</code> command whenever models change and\nyou want to update the database schemas.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> backend\n<span class=\"token comment\"># Generate schema</span>\ndocker-compose <span class=\"token builtin class-name\">exec</span> backend npx sls invoke <span class=\"token builtin class-name\">local</span> -f syncdb\n<span class=\"token comment\"># Populate sample data</span>\ndocker-compose <span class=\"token builtin class-name\">exec</span> backend npx sls invoke <span class=\"token builtin class-name\">local</span> -f syncdb -d populate</code></pre></div>\n<p>If you are using Node 14, you might be able to run the following commands to\nsync a bit faster (without needing to wait for compilation):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> backend <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">npm</span> <span class=\"token function\">install</span>\n<span class=\"token comment\"># Generate schema</span>\n<span class=\"token function\">npm</span> run syncdb\n<span class=\"token comment\"># Populate sample data</span>\n<span class=\"token function\">npm</span> run syncdb -- -d populate</code></pre></div>\n<h3 id=\"manual-access\" style=\"position:relative;\"><a href=\"#manual-access\" aria-label=\"manual access permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Manual access</h3>\n<p>To manually access the database, we use AWS Session Manager. This way, we don't need to run an EC2 bastion instance that's exposed to the public Internet.</p>\n<ul>\n<li>Install the <a href=\"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html\">Session Manager plugin</a> to the AWS CLI on your development machine.</li>\n<li>\n<p>Set up a Session Manager port forwarding session to allow SSH access to the instance.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Set this environment variable to the ID of the EC2 bastion instance (which should be in a private subnet, but able to connect to the RDS instance).</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">INSTANCE_ID</span><span class=\"token operator\">=</span>\n<span class=\"token comment\"># Generate an SSH key and send it to the EC2 instance</span>\n<span class=\"token comment\"># (this only needs to be done once).</span>\nssh-keygen -f cisa_bastion_rsa\naws ec2-instance-connect send-ssh-public-key <span class=\"token punctuation\">\\</span>\n  --instance-id <span class=\"token variable\">$INSTANCE_ID</span> <span class=\"token punctuation\">\\</span>\n  --availability-zone us-east-1b <span class=\"token punctuation\">\\</span>\n  --instance-os-user ec2-user <span class=\"token punctuation\">\\</span>\n  --ssh-public-key file://cisa_bastion_rsa.pub\n\n<span class=\"token comment\"># Start port forwarding.</span>\naws ssm start-session <span class=\"token punctuation\">\\</span>\n  --target <span class=\"token variable\">$INSTANCE_ID</span> <span class=\"token punctuation\">\\</span>\n  --document-name AWS-StartPortForwardingSession <span class=\"token punctuation\">\\</span>\n  --parameters <span class=\"token string\">'{\"portNumber\":[\"22\"], \"localPortNumber\":[\"9999\"]}'</span></code></pre></div>\n</li>\n<li>\n<p>In another terminal, forward the RDS connection to your local computer using the SSH connection from earlier:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Set this environment variable to the URL of the RDS instance (XXX.rds.amazonaws.com)</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RDS_URL</span><span class=\"token operator\">=</span>\n\n<span class=\"token comment\"># Forward RDS instance to localhost:5432</span>\n<span class=\"token function\">ssh</span> ec2-user@localhost <span class=\"token punctuation\">\\</span>\n  -p <span class=\"token number\">9999</span> <span class=\"token punctuation\">\\</span>\n  -N <span class=\"token punctuation\">\\</span>\n  -i cisa_bastion_rsa <span class=\"token punctuation\">\\</span>\n  -L <span class=\"token number\">5432</span>:<span class=\"token variable\">$RDS_URL</span>:5432</code></pre></div>\n</li>\n<li>You should now be able to connect to the database directly from your local computer (with the actual RDS database credentials), at the URL <code class=\"language-text\">localhost:5432</code>. You can use a tool such as <a href=\"https://dbeaver.io/\">DBeaver</a> to more easily handle / manage connections.</li>\n</ul>\n<p>These steps for manual access are based on <a href=\"https://checkmysite.io/blog/using-aws-systems-manager-and-ssh-to-access-an-rds-instance\">Connect to a private RDS instance using SSH &#x26; AWS SSM (Systems Manager)</a>.</p>","frontmatter":{"title":"Database","sidenav":"dev"},"fields":{"slug":"/dev/database/"},"headings":[{"value":"Directory structure","depth":3},{"value":"Models","depth":3},{"value":"Syncing the database","depth":3},{"value":"Manual access","depth":3}]}},"pageContext":{"name":"/dev/database/"}},"staticQueryHashes":["1824138477","3841949133","63159454"]}